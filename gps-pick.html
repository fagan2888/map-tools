
<!DOCTYPE html>
<html>

  <head>

    <title>GPS click-points</title>

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <style>
     html, body {
         height: 100%;
         margin: 0;
         padding: 0;
     }

     .top {
         margin-bottom: 1em;
     }
     .border {
         border-bottom: 1px solid #999;
     }
     .left-space {
         padding-left: 10px;
     }

     #map {
         height: 100%;
     }
     #panel {
         position: absolute;
         top: 2.5%;
         left: 2.5%;
         z-index: 5;
         background-color: #fff;
         padding: 10px;
         border: 1px solid #999;
         text-align: center;
         font-size: 12px;
         font-family: 'Lucida Console', Monaco, monospace;
     }
     #undo {
         margin-top: 1em;
     }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script>
     // All Javascript is here
     function initMap() {

         // Default location
         var pos_default = {lat: 40.704107, lng: -74.014772},
             pos = pos_default
             gps = [],
             label = document.getElementById('label'),
             zoom_default = 1;

         var map = new google.maps.Map(document.getElementById('map'), {
             zoom: zoom_default,
             center: pos,
             disableDoubleClickZoom: true,
             disableDefaultUI: true
         });

         var marker = new google.maps.Marker({
             position: pos,
             map: map
         });

         // Try HTML5 geolocation
         if (navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(function(position) {
                 pos_default = {
                     lat: position.coords.latitude,
                     lng: position.coords.longitude
                 };
                 pos = pos_default;

                 setLocation(map, marker, pos);
             }, function() {
                 setLocation(map, marker, pos);
             });
         } else {
             setLocation(map, marker, pos);
         }

         function setLocation(map, marker, pos) {
             map.setCenter(pos);
             marker.setPosition(pos);
         };

         // Update marker, array of GPS coords, summary table for double click
         var tbl = document.getElementById('tbl'),
             tbl_switch = true;
         // Initialize coordinate table
         instructions = function(tbl) {
             var row = tbl.insertRow(-1),
                 c1 = row.insertCell(0),
                 c2 = row.insertCell(1);
             c1.colSpan = 2;
             c1.textContent = "No points added.";
             tbl_switch = true;
         }
         instructions(tbl)

         google.maps.event.addListener(map, 'dblclick', function(event) {
             var pos = {lat: event.latLng.lat(), lng: event.latLng.lng()};

             setLocation(map, marker, pos);
             gps.push(pos);

             if (tbl_switch) {
                 tbl.deleteRow(1);
                 tbl_switch = false;
             }

             var row = tbl.insertRow(-1),
                 c1 = row.insertCell(0),
                 c2 = row.insertCell(1),
                 c3 = row.insertCell(2);

             // number of lat / lng digits
             var k = 6;
             c1.textContent = pos.lat.toFixed(k);
             c2.textContent = pos.lng.toFixed(k);
         });

         // Undo last point
         document.getElementById('undo').addEventListener('click', function() {
             if (gps.length > 0) {
                 tbl.deleteRow(-1);
                 gps.pop();

                 if (gps.length > 0) {
                     setLocation(map, marker, gps[gps.length-1]);
                 } else {
                     setLocation(map, marker, pos_default);
                     map.setZoom(zoom_default);
                     instructions(tbl);
                 }
             }
         });

         // Reset
         document.getElementById('reset').addEventListener('click', function() {
             if (gps.length > 0) {
                 while (gps.length > 0) {
                     gps.pop();
                     tbl.deleteRow(-1);
                 }
                 setLocation(map, marker, pos_default);
                 map.setZoom(zoom_default);
                 instructions(tbl);
             }
         });

         // CSV download when click
         document.getElementById('csv').addEventListener('click', function() {
             if (gps.length > 0) {
                 var delim = '%2C',
                     nl = '%0A',
                     txt = 'data:application/octet-stream,lat'.concat(delim, 'lng', nl);

                 for (i=0; i < gps.length; i++) {
                     var x = gps[i];
                     txt = txt.concat(String(x.lat), delim, String(x.lng), nl);
                 }
                 document.getElementById('csv').href = txt;
             }
         });
     }

    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbKrdFQsdCPXpASx8gGVllEPhHq7pZy7s&callback=initMap">
    </script>

    <div id="panel">
      <table id="tbl">
        <tr>
          <th colspan="2"><div class="border top">Double click to add new points.</div></th>
          <th><div class="left-space top"><a href="#" id="csv">CSV</a></div></th>

        </tr>
      </table>

      <button id="undo">Undo</button> <button id="reset">Reset</button>
    </div>
  </body>
</html>

